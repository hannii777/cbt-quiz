<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>정수시설운영관리사 CBT</title>
  <!-- 구글 폰트 (Roboto) 추가 -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <style>
    /* 기본 스타일 */
    body {
      font-family: 'Roboto', sans-serif;
      background: #f8f9fa;
      margin: 0;
      padding: 0;
      color: #212529;
      line-height: 1.5;
    }
    /* 상단 헤더 */
    #main-header {
      text-align: center;
      padding: 20px 0;
      font-size: 26px;
      font-weight: 700;
      cursor: pointer;
      color: #0d6efd;
    }
    /* 모드 선택 컨테이너 */
    #mode-container {
      max-width: 800px;
      margin: 20px auto;
      text-align: center;
    }
    #mode-container button {
      margin: 5px;
      padding: 10px 15px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.2s, box-shadow 0.2s;
    }
    #mode-container button:hover {
      background: #0b5ed7;
    }
    /* 회차 선택 컨테이너 */
    #session-container {
      max-width: 800px;
      margin: 20px auto;
      text-align: center;
      display: none;
    }
    #back-to-mode-btn {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: #6c757d;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #back-to-mode-btn:hover {
      background: #5b636a;
    }
    #session-selection button {
      margin: 5px;
      padding: 10px 15px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
    }
    #session-selection button:hover {
      background: #0b5ed7;
    }
    /* CBT 퀴즈 컨테이너 */
    #quiz-container {
      position: relative;
      max-width: 1000px;
      margin: 20px auto;
      background: #fff;
      padding: 40px;
      box-sizing: border-box;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      display: none;
      overflow-y: auto;
    }
    /* 회차명 및 과목 헤더 */
    #session-name {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 10px;
      text-align: center;
      color: #0d6efd;
    }
    #subject-header {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 10px;
      color: #0d6efd;
    }
    /* 문제 텍스트 (번호 포함 후 들여쓰기) */
    .question {
      font-size: 1.2em;
      margin-bottom: 20px;
      padding-left: 1em;
      text-indent: -1em;
      word-break: keep-all;
      overflow-wrap: break-word;
    }
    /* 선택한 답안 표시 영역 */
    #selected-display {
      font-size: 1.1em;
      color: #555;
      margin-bottom: 10px;
    }
    /* 문제 영역 하단 여백 */
    #question-area {
      padding-bottom: 80px;
    }
    /* 세부 설명 */
    .details p {
      margin-top: 6px;
      white-space: pre-line;
    }
    /* 선택지 영역: grid 레이아웃 (2열) */
    .options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 600px;
      margin-bottom: 20px;
    }
    /* 옵션 버튼 기본 스타일 */
    .option-btn {
      width: 100%;
      white-space: normal;
      overflow: visible;
      text-align: left;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #fafafa;
      cursor: pointer;
      transition: background 0.2s, box-shadow 0.2s;
      padding: 10px 12px;
      padding-left: 2em;
      text-indent: -2em;
      line-height: 1.4;
      font-size: 0.9em;
      box-sizing: border-box;
    }
    .option-btn:hover {
      background: #f0f0f0;
    }
    .option-btn.selected {
      background: #ffeb99;
      border-color: #f0a500;
    }
    /* 옵션 길이별 클래스: 20자 초과면 한 행 전체 사용 */
    .short-option {
      /* 기본 2열 유지 */
    }
    .long-option {
      grid-column: span 2;
    }
    /* 피드백 영역 */
    #feedback {
      margin-top: 10px;
      font-weight: bold;
    }
    /* 이전/다음 버튼 */
    #prev-btn, #next-btn {
      position: absolute;
      padding: 10px 20px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #prev-btn:disabled, #next-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #prev-btn { left: 40px; }
    #next-btn { right: 40px; }
    /* 오른쪽 고정 패널 */
    #right-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      display: none;
      background: #fff;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 90vh;
      overflow-y: auto;
    }
    /* 문제 번호 네비게이션 */
    #nav-table {
      display: grid;
      grid-template-columns: repeat(10, auto);
      gap: 5px;
      margin-bottom: 10px;
    }
    .nav-btn {
      padding: 4px 6px;
      background: #f0f0f0;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      min-width: 25px;
      font-size: 12px;
      transition: background 0.2s;
    }
    .nav-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .nav-btn.current {
      border: 2px solid #333;
    }
    #submit-btn {
      padding: 8px 12px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      width: 100%;
      transition: background 0.2s;
    }
    #submit-btn:hover {
      background: #0b5ed7;
    }
    /* 모달창 스타일 */
    #modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modal {
      position: relative;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    #modal h2 {
      margin-top: 0;
      text-align: left;
      position: relative;
      padding-right: 30px;
      font-size: 1.25rem;
    }
    #modal .close-x {
      position: absolute;
      top: 0;
      right: 0;
      background: transparent;
      border: none;
      font-size: 24px;
      line-height: 1;
      cursor: pointer;
      color: #333;
    }
    #modal .modal-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    #modal button {
      padding: 8px 16px;
      background: #0d6efd;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #modal button:hover {
      background: #0b5ed7;
    }
    /* "처음화면" 버튼 */
    #go-back-btn {
      background: #28a745;
    }
    #go-back-btn:hover {
      background: #218838;
    }
    /* 과목별 요약 표 (모달 오른쪽 상단) */
    #subject-summary {
      position: absolute;
      top: 20px;
      right: 20px;
      border: 1px solid #ddd;
      background: #f8f9fa;
      padding: 5px;
      font-size: 0.9em;
      z-index: 1100;
    }
    #subject-summary table {
      border-collapse: collapse;
      width: 100%;
    }
    #subject-summary th, #subject-summary td {
      border: 1px solid #ccc;
      padding: 2px 5px;
      text-align: center;
    }
    #subject-summary th {
      background: #e9ecef;
    }
    
    /* 반응형 디자인 */
    @media (max-width: 768px) {
      .question {
        font-size: 1.1em;
        padding-left: 0.8em;
        text-indent: -0.8em;
      }
      .option-btn {
        font-size: 0.9em;
        padding-left: 1.6em;
        text-indent: -1.6em;
      }
      #prev-btn, #next-btn {
        padding: 8px 12px;
      }
      #quiz-container {
        padding: 20px;
      }
      #subject-summary {
        font-size: 0.8em;
      }
    }
  </style>
</head>
<body>
  <div id="main-header">정수시설운영관리사 CBT</div>
  
  <div id="mode-container">
    <p>모드를 선택하세요</p>
    <button id="practice-mode-btn">연습모드</button>
    <button id="exam-mode-btn">실전모드</button>
  </div>
  
  <div id="session-container">
    <button id="back-to-mode-btn">모드 선택</button>
    <p>풀고 싶은 회차를 선택하세요.</p>
    <div id="session-selection"></div>
  </div>
  
  <div id="quiz-container">
    <div id="session-name"></div>
    <div id="subject-header"></div>
    <div id="question-area">
      <p class="question" id="question-text"></p>
      <!-- 선택한 답안 표시 영역 -->
      <div id="selected-display"></div>
      <div id="details" class="details"></div>
      <div id="options" class="options"></div>
      <div id="feedback"></div>
    </div>
    <button id="prev-btn">이전 문제</button>
    <button id="next-btn">다음 문제</button>
  </div>
  
  <div id="right-panel">
    <div id="nav-table"></div>
    <button class="nav-btn" id="submit-btn">채점하기</button>
  </div>
  
  <!-- 채점 결과 모달 -->
  <div id="modal-overlay">
    <div id="modal">
      <h2>
        채점 결과
        <button class="close-x" id="modal-close">&times;</button>
      </h2>
      <!-- 과목별 요약 표 (오른쪽 상단) -->
      <div id="subject-summary"></div>
      <div id="modal-session-name" style="font-weight:500; margin-bottom:10px; color:#0d6efd;"></div>
      <div id="modal-content"></div>
      <div class="modal-buttons">
        <button id="close-modal">닫기</button>
        <button id="go-back-btn">처음화면</button>
      </div>
    </div>
  </div>
  
  <script>
    let questions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentSession = "";
    let currentMode = "";
    
    const modeContainer = document.getElementById("mode-container");
    const practiceModeBtn = document.getElementById("practice-mode-btn");
    const examModeBtn = document.getElementById("exam-mode-btn");
    
    const sessionContainer = document.getElementById("session-container");
    const sessionSelection = document.getElementById("session-selection");
    const backToModeBtn = document.getElementById("back-to-mode-btn");
    
    const quizContainer = document.getElementById("quiz-container");
    const sessionNameDiv = document.getElementById("session-name");
    const subjectHeader = document.getElementById("subject-header");
    const questionText = document.getElementById("question-text");
    const selectedDisplay = document.getElementById("selected-display");
    const detailsDiv = document.getElementById("details");
    const optionsDiv = document.getElementById("options");
    const feedbackDiv = document.getElementById("feedback");
    
    const prevBtn = document.getElementById("prev-btn");
    const nextBtn = document.getElementById("next-btn");
    const navTable = document.getElementById("nav-table");
    const rightPanel = document.getElementById("right-panel");
    const submitBtn = document.getElementById("submit-btn");
    
    const modalOverlay = document.getElementById("modal-overlay");
    const modalContent = document.getElementById("modal-content");
    const modalSessionName = document.getElementById("modal-session-name");
    const closeModalBtn = document.getElementById("close-modal");
    const modalCloseX = document.getElementById("modal-close");
    const goBackBtn = document.getElementById("go-back-btn");
    const mainHeader = document.getElementById("main-header");
    const subjectSummary = document.getElementById("subject-summary");
    
    // 과목명을 반환하는 함수
    function getSubjectName(qid) {
      if (qid >= 1 && qid <= 20) return "1과목 수처리공정";
      if (qid >= 21 && qid <= 40) return "2과목 수질분석 및 관리";
      if (qid >= 41 && qid <= 60) return "3과목 설비운영(기계ㆍ장치 또는 계측기 등)";
      if (qid >= 61 && qid <= 80) return "4과목 정수시설 수리학";
      return "";
    }
    
    // 옵션 문자열 분할 함수: 기호와 내용 사이에 공백 추가
    function processOptions(options) {
      let newOptions = [];
      options.forEach(option => {
        let splitOptions = option.split(/(?=[①②③④⑤⑥⑦⑧⑨⑩])/);
        splitOptions.forEach(opt => {
          let trimmed = opt.trim();
          if (trimmed !== "") {
            if (/^[①②③④⑤⑥⑦⑧⑨⑩](\S)/.test(trimmed)) {
              trimmed = trimmed[0] + " " + trimmed.slice(1);
            }
            newOptions.push(trimmed);
          }
        });
      });
      return newOptions;
    }
    
    // 모드 선택 이벤트
    practiceModeBtn.addEventListener("click", function() {
      currentMode = "practice";
      modeContainer.style.display = "none";
      sessionContainer.style.display = "block";
      rightPanel.style.display = "none";
    });
    examModeBtn.addEventListener("click", function() {
      currentMode = "exam";
      modeContainer.style.display = "none";
      sessionContainer.style.display = "block";
      rightPanel.style.display = "none";
    });
    
    // 모드 선택 복귀
    backToModeBtn.addEventListener("click", function() {
      sessionContainer.style.display = "none";
      modeContainer.style.display = "block";
      rightPanel.style.display = "none";
      navTable.innerHTML = "";
    });
    
    // 회차 선택 버튼 생성
    function createSessionButtons() {
      for (let i = 20; i <= 36; i++) {
        const btn = document.createElement("button");
        btn.textContent = `정수시설운영관리사 ${i}회_2급`;
        btn.addEventListener("click", function() {
          loadQuestions(i);
        });
        sessionSelection.appendChild(btn);
      }
    }
    
    // 회차 선택 및 JSON 불러오기
    function loadQuestions(session) {
      const jsonFilePath = encodeURI(`https://haruto7777.github.io/cbt-quiz/${session}회차.json`);
      fetch(jsonFilePath)
        .then(response => response.json())
        .then(data => {
          questions = data;
          userAnswers = new Array(questions.length).fill(null);
          currentSession = `정수시설운영관리사 ${session}회_2급`;
          mainHeader.textContent = currentSession;
          sessionNameDiv.textContent = currentSession;
          sessionContainer.style.display = "none";
          quizContainer.style.display = "block";
          rightPanel.style.display = "block";
          navTable.innerHTML = "";
          showQuestion(0);
          updateNavTable();
        })
        .catch(error => alert("문제를 불러오는 데 실패했습니다: " + error.message));
    }
    
    // 과목 헤더 업데이트
    function updateSubjectHeader() {
      const qid = questions[currentQuestionIndex].id;
      subjectHeader.textContent = getSubjectName(qid);
    }
    
    // 문제 표시
    function showQuestion(index) {
      currentQuestionIndex = index;
      const q = questions[index];
      questionText.textContent = q.question;
      updateSubjectHeader();
      
      // 선택한 답안 표시 업데이트
      let processedOptions = processOptions(q.options);
      if (userAnswers[index] !== null) {
        selectedDisplay.textContent = "선택한 답: " + processedOptions[userAnswers[index]];
      } else {
        selectedDisplay.textContent = "선택한 답: 없음";
      }
      
      // 세부 설명 처리 (줄바꿈 기준)
      detailsDiv.innerHTML = "";
      if (q.details && q.details.length > 0) {
        q.details.forEach(detail => {
          let lines = detail.split("\n");
          lines.forEach(line => {
            line = line.trim();
            if (line) {
              const p = document.createElement("p");
              p.textContent = line;
              detailsDiv.appendChild(p);
            }
          });
        });
      }
      
      optionsDiv.innerHTML = "";
      feedbackDiv.textContent = "";
      processedOptions.forEach((option, idx) => {
        const btn = document.createElement("button");
        btn.textContent = option;
        btn.className = "option-btn";
        // 옵션 길이 기준: 20자 초과이면 전체 행(span 2) 사용
        if (option.length > 20) {
          btn.classList.add("long-option");
          btn.style.gridColumn = "span 2";
        } else {
          btn.classList.add("short-option");
        }
        if (userAnswers[index] === idx) {
          btn.classList.add("selected");
        }
        btn.addEventListener("click", function() {
          if (currentMode === "practice") {
            if (userAnswers[index] !== null) return;
            userAnswers[index] = idx;
            if (idx === q.answer - 1) {
              feedbackDiv.style.color = "#5cb85c";
              feedbackDiv.textContent = "정답입니다!";
            } else {
              feedbackDiv.style.color = "#d9534f";
              feedbackDiv.textContent = `오답입니다. 정답은: ${processedOptions[q.answer - 1]}`;
            }
            updateNavTable();
          } else {
            userAnswers[index] = idx;
            updateNavTable();
          }
          selectedDisplay.textContent = "선택한 답: " + processedOptions[userAnswers[index]];
        });
        optionsDiv.appendChild(btn);
      });
      updateNavigation();
      updateNavTable();
      
      // 연습모드: 이전/다음 버튼 위치 조정
      if (currentMode === "practice") {
        prevBtn.style.bottom = "80px";
        nextBtn.style.bottom = "80px";
      } else {
        prevBtn.style.bottom = "20px";
        nextBtn.style.bottom = "20px";
      }
    }
    
    function updateOptions() {
      showQuestion(currentQuestionIndex);
    }
    
    // 이전/다음 버튼 활성화
    function updateNavigation() {
      prevBtn.disabled = currentQuestionIndex === 0;
      nextBtn.disabled = currentQuestionIndex === questions.length - 1;
    }
    
    // 내비게이션 업데이트
    function updateNavTable() {
      navTable.innerHTML = "";
      for (let i = 0; i < questions.length; i++) {
        const btn = document.createElement("button");
        btn.textContent = i + 1;
        btn.className = "nav-btn";
        if (userAnswers[i] !== null) {
          if (currentMode === "practice") {
            if (userAnswers[i] === questions[i].answer - 1) {
              btn.style.background = "#007bff";
            } else {
              btn.style.background = "#d9534f";
            }
          } else {
            btn.style.background = "#add8e6";
          }
        } else {
          btn.style.background = "#f0f0f0";
        }
        if (i === currentQuestionIndex) {
          btn.classList.add("current");
        }
        btn.addEventListener("click", function() {
          showQuestion(i);
        });
        navTable.appendChild(btn);
      }
    }
    
    // 채점 및 과목별 그룹화, 요약 표 생성
    submitBtn.addEventListener("click", function() {
      let score = 0;
      const wrongBySubject = {
        "1과목 수처리공정": [],
        "2과목 수질분석 및 관리": [],
        "3과목 설비운영(기계ㆍ장치 또는 계측기 등)": [],
        "4과목 정수시설 수리학": []
      };
      const correctBySubject = {
        "1과목 수처리공정": [],
        "2과목 수질분석 및 관리": [],
        "3과목 설비운영(기계ㆍ장치 또는 계측기 등)": [],
        "4과목 정수시설 수리학": []
      };
      
      questions.forEach((q, idx) => {
        const subj = getSubjectName(q.id);
        let processedOptions = processOptions(q.options);
        if (userAnswers[idx] !== null && userAnswers[idx] === q.answer - 1) {
          score++;
          correctBySubject[subj].push(q.id);
        } else {
          wrongBySubject[subj].push({
            id: q.id,
            question: q.question,
            selected: userAnswers[idx] !== null ? processedOptions[userAnswers[idx]] : "미응답",
            correct: processedOptions[q.answer - 1]
          });
        }
      });
      
      // 과목별 요약 표 생성 (모달 오른쪽 상단)
      let summaryHTML = `<table>
        <tr>
          <th>과목</th>
          <th>오답 수</th>
        </tr>`;
      const subjects = ["1과목 수처리공정", "2과목 수질분석 및 관리", "3과목 설비운영(기계ㆍ장치 또는 계측기 등)", "4과목 정수시설 수리학"];
      subjects.forEach(subj => {
        summaryHTML += `<tr>
          <td>${subj}</td>
          <td>${wrongBySubject[subj].length}</td>
        </tr>`;
      });
      summaryHTML += `</table>`;
      subjectSummary.innerHTML = summaryHTML;
      
      // 채점 결과 상세 내용: 각 과목별로 틀린 문제 먼저, 그 후 맞은 문제 번호
      let resultHTML = `<p><strong>총 점수: ${score} / ${questions.length}</strong></p>`;
      subjects.forEach(subj => {
        resultHTML += `<h3>${subj}</h3>`;
        if (wrongBySubject[subj].length > 0) {
          resultHTML += `<p>틀린 문제 번호: ${wrongBySubject[subj].map(item => item.id).join(", ")}</p>`;
          wrongBySubject[subj].forEach(item => {
            resultHTML += `<p><strong>문제 ${item.id}:</strong> ${item.question}</p>`;
            resultHTML += `<p>내 선택: ${item.selected}</p>`;
            resultHTML += `<p>정답: ${item.correct}</p><hr>`;
          });
        } else {
          resultHTML += `<p>틀린 문제 없음</p>`;
        }
        if (correctBySubject[subj].length > 0) {
          resultHTML += `<p>맞은 문제 번호: ${correctBySubject[subj].join(", ")}</p>`;
        } else {
          resultHTML += `<p>맞은 문제 없음</p>`;
        }
      });
      
      modalSessionName.textContent = currentSession;
      modalContent.innerHTML = resultHTML;
      modalOverlay.style.display = "flex";
    });
    
    // 닫기 버튼 및 X 버튼 클릭 시, ESC키 사용 시에도 확인 후 모달 닫기
    function closeModalWithConfirm() {
      if (confirm("정말 닫겠습니까?")) {
        modalOverlay.style.display = "none";
      }
    }
    
    closeModalBtn.addEventListener("click", closeModalWithConfirm);
    modalCloseX.addEventListener("click", closeModalWithConfirm);
    
    document.addEventListener("keydown", function(e) {
      if (e.key === "Escape" && modalOverlay.style.display === "flex") {
        closeModalWithConfirm();
      }
    });
    
    function goToSessionSelection() {
      modalOverlay.style.display = "none";
      quizContainer.style.display = "none";
      rightPanel.style.display = "none";
      sessionContainer.style.display = "block";
      mainHeader.textContent = "정수시설운영관리사 CBT";
      sessionNameDiv.textContent = "";
      navTable.innerHTML = "";
      questions = [];
      userAnswers = [];
      currentSession = "";
    }
    goBackBtn.addEventListener("click", goToSessionSelection);
    mainHeader.addEventListener("click", goToSessionSelection);
    
    createSessionButtons();
  </script>
</body>
</html>
